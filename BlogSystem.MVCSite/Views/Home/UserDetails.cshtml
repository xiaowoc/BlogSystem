@model UserInformationDto
@using BlogSystem.DTO
@{
    ViewBag.Title = "用户详情";
    Layout = "~/Views/Shared/_Layout.cshtml";
    List<ArticleDto> topArticles = ViewBag.TopArticles;
}

<div class="container-xl">
    <div class="row">
        <div class="toast position-fixed mx-auto" data-delay="2000" role="alert" aria-live="assertive" aria-atomic="true" style="left:0;right:0;top:20%;z-index:100;">
            <div class="toast-header">
                <strong class="mr-auto">提示</strong>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="toast-body">

            </div>
        </div>

        <div class="col-md-9">
            <div class="whiteBlock">
                <div>
                    <p class="text-muted h5">置顶</p>
                </div>
                <div>
                    @if (topArticles.Count != 0)
                    {
                        foreach (ArticleDto item in ViewBag.TopArticles)
                        {
                            <div class="mt-3">
                                <hr />
                                <strong class="d-block h3">
                                    <a href="/Article/ArticleDetails/@item.Id" class=" text-decoration-none">@item.Title</a>
                                </strong>
                                <div class="py-2">
                                    <p class="h6">@item.Content</p>
                                </div>
                                <div>
                                    <span><img class="myIcon" src="/IconSvg/calendar.svg" title="创建日期" /> @item.CreateTime</span>
                                    <span><img class="myIcon" src="/IconSvg/like.svg" title="喜欢" />@item.GoodCount</span>
                                    <span><img class="myIcon" src="/IconSvg/hate.svg" title="不喜欢" />@item.BadCount</span>
                                </div>
                                <div id="categories">
                                    @for (int i = 0; i < item.CategoryIds.Count(); i++)
                                    {
                                        <a href="/Article/ArticleList?userId=@Model.Id&categoryId=@item.CategoryIds[i]" class="badge badge-danger mr-1">@item.CategoryNames[i]</a>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <hr />
                        <strong>暂无置顶</strong>
                    }
                </div>
            </div>
            <div class="whiteBlock">
                <div class="d-flex">
                    <p class="text-decoration-none text-muted mr-1 h5">最新博客</p>
                    <a href="/Article/ArticleList?userId=@Model.Id" class="ml-auto text-muted">更多</a>
                </div>
                @foreach (ArticleDto item in ViewBag.LatestArticles)
                {
                    <div class="mt-3">
                        <hr />
                        <strong class="d-block h3">
                            <a href="/Article/ArticleDetails/@item.Id" class=" text-decoration-none">@item.Title</a>
                        </strong>
                        <div class="py-2">
                            <p class="h6">@item.Content</p>
                        </div>
                        <div>
                            <span><img class="myIcon" src="/IconSvg/calendar.svg" title="创建日期" /> @item.CreateTime</span>
                            <span><img class="myIcon" src="/IconSvg/like.svg" title="喜欢" />@item.GoodCount</span>
                            <span><img class="myIcon" src="/IconSvg/hate.svg" title="不喜欢" />@item.BadCount</span>
                        </div>
                        <div id="categories">
                            @for (int i = 0; i < item.CategoryIds.Count(); i++)
                            {
                                <a href="/Article/ArticleList?userId=@Model.Id&categoryId=@item.CategoryIds[i]" class="badge badge-warning mr-1">@item.CategoryNames[i]</a>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="col-md-3 d-none d-md-block">
            <div class="sticky-top">
                <div class="whiteBlock text-center">
                    <img class="rounded-circle m-2" style="width:88px;height:88px;border-radius:50%" src="~/Image/@Model.ImagePath" />
                    <p class="m-2">@Model.Email</p>
                    <p>@Model.Nickname</p>
                    <span class="badge badge-info">关注 @Model.FocusCount 人</span>
                    <span class="badge badge-info">粉丝 @Model.FansCount 人</span>
                    @if (ViewBag.IsFocused)//已关注
                    {
                        <a href="#" id="btnunFocus" class="badge badge-secondary">√ 已关注</a>
                    }
                    else//未关注
                    {
                        <a href="#" id="btnFocus" class="badge badge-danger">点我关注</a>
                    }
                </div>
                <div class="whiteBlock">
                    <p>标签</p>
                    <div id="categoriesDiv">
                        @foreach (var item in ViewBag.TenTags)
                        {
                            <a href="/Article/ArticleList?userId=@Model.Id&categoryId=@item.Id" class="badge badge-success mr-1">@item.BlogCategoryName</a>
                        }
                        <a class="badge badge-info" href="javascript:void(0);" onclick="getMoreCategories('@Model.Id')">更多</a>
                    </div>
                </div>
                <div class="whiteBlock">
                    <p>归档</p>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>文章总计</span>
                            <span class="badge badge-pill badge-info ">@ViewBag.ArticlesCount</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>分类总计</span>
                            <span class="badge badge-pill badge-info ">@ViewBag.CategoriesCount</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script>
        $(function () {//初始化绑定点击事件和hover事件
            $("#btnFocus").on('click', function () {
                $("#btnFocus").bind('click', FocusUser());
            });
            $("#btnunFocus").on('click', function () {
                $("#btnunFocus").bind('click', UnFocusUser());
            });
            $("#btnunFocus").hover(function () {
                $("#btnunFocus").text("取消关注");
            },function () {
                    $("#btnunFocus").text("√ 已关注");
            });
        })

        function FocusUser() {
            var focusUserId = '@Model.Id';
            $.ajax({
                url: "/Home/FocusUser/",
                dataType: "json",
                data: { focusUserId: focusUserId },
                type: "post",
                success: function (data) {
                    $(".toast-body").text(data.result);
                    $(".toast").toast('show');
                    if (data.status == "ok") {
                        $("#btnFocus").text('√ 已关注');//修改显示内容
                        $("#btnFocus").attr('class', 'badge badge-secondary');//更换显示class
                        $("#btnFocus").unbind();//取消绑定事件
                        $("#btnFocus").attr('id', 'btnunFocus');//id修改
                        $("#btnunFocus").hover(function () {//再给新id绑定hover事件
                            $("#btnunFocus").text("取消关注");
                        }, function () {
                            $("#btnunFocus").text("√ 已关注");
                        });
                        $("#btnunFocus").on('click', function () {//再给新id绑定点击事件
                            $("#btnunFocus").bind('click', UnFocusUser());
                        });
                    } else if (data.status == "fail") {
                        $(".toast-body").text(data.result);
                        $(".toast").show();
                        $(".toast").toast('show');
                    }
                }
            })
        }

        function UnFocusUser() {
            var focusUserId = '@Model.Id';
            $.ajax({
                url: "/Home/UnFocusUser/",
                dataType: "json",
                data: { focusUserId: focusUserId },
                type: "post",
                success: function (data) {
                    $(".toast-body").text(data.result);
                    $(".toast").toast('show');
                    if (data.status == "ok") {
                        $("#btnunFocus").text('关注');
                        $("#btnunFocus").attr('class', 'badge badge-danger');
                        $("#btnunFocus").unbind();
                        $("#btnunFocus").attr('id', 'btnFocus');
                        $("#btnFocus").on('click', function () {
                            $("#btnFocus").bind('click', FocusUser());
                        });
                    } else if (data.status == "fail") {
                        $(".toast-body").text(data.result);
                        $(".toast").show();
                        $(".toast").toast('show');
                    }
                }
            })
        }

        function getMoreCategories(userId) {
            $.ajax({
                url: "/Article/GetMoreCategories",
                type: "get",
                dataType: "json",
                data: { userId },
                success: function (data) {
                    if (data.status=="ok") {
                        var categoriesHtml = "";
                        for (var i = 0; i < data.data.length; i++) {
                            var tag = data.data[i];
                            categoriesHtml += '<a href="/Article/ArticleList?userId=' + data.userId + '&categoryId=' + tag.Id + '" class="badge badge-success mr-1">' + tag.BlogCategoryName + '</a>';
                        }
                        $("#categoriesDiv").html(categoriesHtml);
                    } else if (
                        data.status == "fail") {
                        $(".toast-body").text(data.result);
                        $(".toast").show();
                        $(".toast").toast('show');
                    }
                }
            })
        }
    </script>
}